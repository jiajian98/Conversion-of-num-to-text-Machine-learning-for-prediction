# -*- coding: utf-8 -*-
"""models

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1FAZjiPrX0SJQTavUOlxkETwPpWO2BBph
"""

from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error, r2_score
from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import StandardScaler, OneHotEncoder
from sklearn.pipeline import Pipeline
from sklearn.compose import ColumnTransformer
import pandas as pd
import numpy as np


df = pd.read_csv("/home/bike_sharing.csv")
df.head()

#preprocess the data by dropping irrelevant columns
df_model = df.drop(['instant','dteday','casual','registered'],axis=1)

x=df_model.drop('cnt',axis=1)
y=df_model['cnt']

#split the features based on their types(catagory or numerical)
f_category = ['season','yr','mnth','hr','holiday','weekday','workingday','weathersit']
f_numerical = ['temp','hum','windspeed']

x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=0.2, random_state=42)
model = LinearRegression()
model.fit(x_train, y_train)

preprocessor = ColumnTransformer([('cat',OneHotEncoder(handle_unknown='ignore'),f_category),
                                  ('num',StandardScaler(),f_numerical)
])

#Initialize the Linear Regression
model = Pipeline([('preprocess',preprocessor),
                  ('regressor',LinearRegression())])

model.fit(x_train,y_train)

y_pred_train = model.predict(x_train)
y_pred_test = model.predict(x_test)

#Evaluate the metric
print("----- Model Evaluation (Linear Regression) -----")
print("Metrics of Training set: ")
R2_train = r2_score(y_train, y_pred_train)
print(f"R2: {R2_train:.4f}")

mse_train = mean_squared_error(y_train, y_pred_train)
rmse_train = np.sqrt(mse_train)
print(f"RMSE: {rmse_train:.4f}\n")

print("Metrics of Test set")
R2_test = r2_score(y_test, y_pred_test)
print(f"R2: {R2_test:.4f}")

mse_test = mean_squared_error(y_test, y_pred_test)
rmse_test = np.sqrt(mse_test)
print(f"RMSE: {rmse_test:.4f}")

#Initialize the Gradient Boosting Methods (Light GBM)
from lightgbm import LGBMRegressor

lgb_model = Pipeline([('preprocess',preprocessor),
                  ('regressor',LGBMRegressor(
                      n_estimators=500,
                      learning_rate=0.05,
                      num_leaves=50,
                      random_state=50))
                  ])

lgb_model.fit(x_train,y_train)
y_lgb_pred_train = lgb_model.predict(x_train)
y_lgb_pred_test = lgb_model.predict(x_test)

#Evaluate the metric
print("----- Model Evaluation (LGBM Regression) -----")
print("Metrics of Training set: ")
R2_lgb_train = r2_score(y_train, y_lgb_pred_train)
print(f"R2: {R2_lgb_train:.4f}")

mse_lgb_train = mean_squared_error(y_train, y_lgb_pred_train)
rmse_lgb_train = np.sqrt(mse_lgb_train)
print(f"RMSE: {rmse_lgb_train:.4f}\n")

print("Metrics of Test set")
R2_lgb_test = r2_score(y_test, y_lgb_pred_test)
print(f"R2: {R2_lgb_test:.4f}")

mse_lgb_test = mean_squared_error(y_test, y_lgb_pred_test)
rmse_lgb_test = np.sqrt(mse_lgb_test)
print(f"RMSE: {rmse_lgb_test:.4f}")

#Comparison between 2 models
results = pd.DataFrame({
    'Model':['Linear Regression','LGBM'],
    'RMSE': [rmse_test,rmse_lgb_test],
    'R2': [R2_test,R2_lgb_test]
})
results[['RMSE','R2']] = results[['RMSE','R2']].round(4)
display(results.sort_values('RMSE'))

model_choose = 'Linear Regression' if rmse_test < rmse_lgb_test else 'LGBM'
print(f"The {model_choose} is chosen as it performs better")


#Predicted vs actual visualisation
import matplotlib.pyplot as plt
import seaborn as sns

y_pred_choose = y_pred_test if model_choose == 'Linear Regression' else y_lgb_pred_test

result_df = pd.DataFrame({
    'Actual':y_test,
    'Predicted':y_pred_choose
})

plt.figure(figsize=(8,5))
sns.scatterplot(x='Actual',y='Predicted',data=result_df)
sns.lineplot(x=[y_test.min(),y_test.max()],
         y=[y_test.min(),y_test.max()],
         color='red')
plt.xlabel("Actual Bike Rentals")
plt.ylabel("Predicted Bike Rentals")
plt.title(f"Actual Bike Rentals by {model_choose}")
plt.show()